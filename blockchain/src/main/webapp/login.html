<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DID 登录 - 区块链应用 (Web Crypto API + IndexedDB)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .login-container { min-width: 380px; }
        .hidden { display: none; }
        textarea { white-space: pre; overflow-wrap: normal; overflow-x: scroll; font-size: 0.8em; }
        .code-block {
            background-color: #f0f0f0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
            word-break: break-all;
            margin-top: 4px;
            max-height: 100px;
            overflow-y: auto;
        }
        .button-action {
            background-color: #4F46E5; /* Indigo */
            color: white;
        }
        .button-action:hover {
            background-color: #4338CA;
        }
        .button-secondary-action { /* 新增：匿名登录按钮样式 */
            background-color: #10B981; /* Green */
            color: white;
        }
        .button-secondary-action:hover {
            background-color: #059669;
        }
        .button-danger {
            background-color: #DC2626; /* Red */
            color: white;
        }
        .button-danger:hover {
            background-color: #B91C1C;
        }
        #keyManagementArea button, #keyManagementArea select { margin-top: 8px; }
        #storedKeysDisplay ul { list-style-type: none; padding-left: 0; }
        #storedKeysDisplay li { padding: 5px; border-bottom: 1px solid #eee; cursor: pointer; }
        #storedKeysDisplay li:hover { background-color: #e9e9e9; }
        #storedKeysDisplay li.selected-did { background-color: #d1d5db; font-weight: bold; }
        
        /* 新增样式 */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tabs button {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tabs button:hover {
            color: #4F46E5;
        }
        .tabs button.tab-active {
            color: #4F46E5;
            border-bottom: 2px solid #4F46E5;
            font-weight: 600;
        }
        
        #pubKeyInput, #manualSignatureInput {
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .code-font {
            font-family: monospace;
        }
        
        /* 重置认证按钮样式 */
        .reset-auth-button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: #EF4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }
        .reset-auth-button:hover {
            background-color: #DC2626;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
<!-- 重置认证状态按钮 -->
<button id="resetAuthButton" class="reset-auth-button">重置认证状态</button>

<div class="login-container bg-white p-8 md:p-12 rounded-lg shadow-xl w-full max-w-lg">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">身份认证</h2>

    <!-- 检测循环重定向的警告 -->
    <div id="redirectWarning" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6">
        <p class="font-bold">检测到可能的循环重定向</p>
        <p>您可能遇到了认证状态不同步问题。请尝试以下解决方案:</p>
        <ol class="list-decimal pl-5 mt-2">
            <li>点击页面右上角的"重置认证状态"按钮</li>
            <li>完成重置后，按正常流程登录</li>
            <li>如果问题仍然存在，请尝试清除浏览器缓存</li>
        </ol>
    </div>

    <div id="authOptions" class="mb-6 space-y-3">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">选择登录方式</h3>
        <button id="showDidLoginButton" class="w-full py-2 px-4 text-sm button-action rounded-md">DID 身份认证</button>
        <button id="anonymousLoginButton" class="w-full py-2 px-4 text-sm button-secondary-action rounded-md">匿名访问</button>
    </div>


    <div id="didAuthSection" class="hidden">
        <h3 class="text-xl font-semibold text-center text-gray-800 mb-4">DID 身份认证</h3>

        <div class="tabs mb-4">
            <button id="createDidTab" class="p-2 text-sm font-medium tab-active">创建DID</button>
            <button id="useDidTab" class="p-2 text-sm font-medium">使用已有DID</button>
        </div>
        
        <!-- 创建DID面板 -->
        <div id="createDidPanel" class="mb-6 p-4 border rounded-md bg-slate-50">
            <div class="mb-4 flex space-x-2">
                <button id="genKeyBtn" class="flex-1 py-2 px-3 text-sm button-secondary-action rounded-md">生成密钥</button>
                <button id="uploadKeyBtn" class="flex-1 py-2 px-3 text-sm button-action rounded-md">上传公钥</button>
            </div>
            
            <!-- 上传公钥区域 -->
            <div id="uploadKeyArea" class="hidden mt-3">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">公钥 (Base64/PEM):</label>
                    <textarea id="pubKeyInput" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="粘贴PEM格式公钥或Base64编码的公钥"></textarea>
                </div>
                <div class="flex space-x-2 mb-3">
                    <button id="selectKeyFileBtn" class="flex-1 py-1 px-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-md">选择文件</button>
                    <input type="file" id="keyFileInput" class="hidden" accept=".pem,.key,.pub">
                    <button id="createDidFromKeyBtn" class="flex-1 py-1 px-2 text-xs button-action rounded-md">创建DID</button>
                </div>
            </div>
            
            <!-- 生成密钥区域 -->
            <div id="genKeyArea" class="mt-3">
                <button id="createDidButton" class="w-full py-2 px-4 text-sm button-action rounded-md">生成密钥并创建DID</button>
                <p class="mt-2 text-xs text-gray-500">系统将生成新密钥对并自动注册DID</p>
            </div>
            
            <div id="createdDidInfo" class="hidden mt-4 p-3 bg-gray-100 rounded-md text-sm"></div>
        </div>
        
        <!-- 使用已有DID面板 -->
        <div id="useDidPanel" class="hidden mb-6 p-4 border rounded-md bg-slate-50">
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">本地存储的DID:</label>
                <div class="flex space-x-2">
                    <select id="didSelector" class="block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">-- 请选择 --</option>
                    </select>
                    <button id="useDidBtn" class="py-2 px-3 text-sm button-secondary-action rounded-md">使用</button>
                    <button id="deleteDidBtn" class="py-2 px-3 text-sm button-danger rounded-md">删除</button>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">手动输入DID:</label>
                <div class="flex space-x-2">
                    <input type="text" id="manualDidInput" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="did:example:123...">
                    <button id="useManualDidBtn" class="py-2 px-3 text-sm button-secondary-action rounded-md">使用</button>
                </div>
            </div>
        </div>

        <!-- 认证流程面板 -->
        <div id="authPanel" class="space-y-4">
            <div id="step1GetChallenge">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">当前DID:</label>
                    <input type="text" id="currentDidInput" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                </div>
                <button id="getChallengeBtn" class="w-full py-2 px-4 text-sm button-action rounded-md">获取挑战码</button>
            </div>
            
            <div id="step2SignChallenge" class="hidden">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">挑战码:</label>
                    <div class="flex space-y-1 flex-col">
                        <textarea id="challengeText" readonly rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"></textarea>
                        <button id="copyChallenge" class="self-end py-1 px-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-md">复制</button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">密钥ID:</label>
                    <input type="text" id="keyIdInput" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                
                <div class="mb-3">
                    <div class="flex space-x-2">
                        <button id="signWithLocalBtn" class="flex-1 py-2 px-3 text-sm button-secondary-action rounded-md">浏览器签名</button>
                        <button id="toggleManualSignBtn" class="flex-1 py-2 px-3 text-sm button-action rounded-md">手动签名</button>
                    </div>
                </div>
                
                <div id="manualSignArea" class="hidden mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">签名结果 (Base64):</label>
                    <textarea id="manualSignatureInput" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="将签名结果粘贴此处"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">签名:</label>
                    <textarea id="signatureText" readonly rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"></textarea>
                </div>
                
                <div class="flex flex-col space-y-2">
                    <button id="verifyBtn" class="w-full py-2 px-4 text-sm bg-green-600 hover:bg-green-700 text-white rounded-md">验证登录</button>
                    <button id="backBtn" class="w-full py-2 px-4 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md">返回</button>
                </div>
            </div>
        </div>
    </div>

    <div id="anonymousAuthSection" class="hidden mt-6 space-y-4 p-4 border rounded-md bg-slate-50">
        <h3 class="text-xl font-semibold text-center text-gray-800 mb-4">匿名访问</h3>
        <button id="initiateAnonymousAuthButton" class="w-full py-2 px-4 text-sm button-secondary-action rounded-md">获取挑战码</button>
        <div id="anonymousChallengeDisplay" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">挑战码:</label>
            <p id="anonymousChallengeText" class="code-block"></p>
            <button id="signAnonymousChallengeButton" class="mt-2 w-full py-2 px-4 text-sm button-action rounded-md">生成密钥并签名</button>
        </div>
        <div id="anonymousVerificationDisplay" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">临时公钥:</label>
            <textarea id="anonymousTempPublicKey" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 sm:text-sm h-16"></textarea>
            <label class="block text-sm font-medium text-gray-700 mb-1 mt-2">签名:</label>
            <textarea id="anonymousSignature" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 sm:text-sm h-16"></textarea>
            <button id="verifyAnonymousAuthButton" class="mt-2 w-full py-2 px-4 text-sm bg-green-600 hover:bg-green-700 text-white rounded-md">验证登录</button>
        </div>
        <button id="backToAuthOptionsButton" class="mt-4 w-full py-2 px-4 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md">返回</button>
    </div>


    <div id="messageArea" class="mt-6 text-center text-sm"></div>
    <div id="createdDidInfo" class="hidden mt-2 p-3 bg-gray-100 rounded text-xs space-y-1"></div>

</div>

<!-- 添加脚本 -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 检查URL参数是否包含no_redirect标记
        const urlParams = new URLSearchParams(window.location.search);
        const noRedirect = urlParams.get('no_redirect') === 'true';
        
        // 如果有no_redirect标记，则不执行自动重定向
        if (noRedirect) {
            return;
        }
        
        // 检查当前是否已经登录
        if (localStorage.getItem('blockchain_auth_status') === 'authenticated') {
            // 获取重定向URL参数，如果没有则默认到index.html
            const redirectUrl = urlParams.get('redirect') || 'index.html';
            
            // 显示已登录状态
            messageArea.textContent = '您已经登录，正在跳转...';
            messageArea.className = 'mt-6 text-center text-sm text-green-600';
            
            // 检查是否可能陷入循环重定向
            const redirectCount = parseInt(localStorage.getItem('redirect_count') || '0');
            if (redirectCount > 5) {
                // 重置重定向计数器
                localStorage.setItem('redirect_count', '0');
                // 显示错误提示
                messageArea.textContent = '检测到循环重定向。请尝试清除浏览器缓存或手动登录。';
                messageArea.className = 'mt-6 text-center text-sm text-red-600';
                // 显示循环重定向警告
                document.getElementById('redirectWarning').classList.remove('hidden');
                return;
            }
            
            // 增加重定向计数
            localStorage.setItem('redirect_count', (redirectCount + 1).toString());
            
            // 跳转到目标页面
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1000);
        } else {
            // 重置重定向计数器
            localStorage.setItem('redirect_count', '0');
        }
        
        // 处理重置认证状态按钮
        document.getElementById('resetAuthButton').addEventListener('click', function() {
            localStorage.removeItem('blockchain_auth_status');
            localStorage.removeItem('blockchain_auth_token');
            localStorage.removeItem('blockchain_auth_did');
            localStorage.removeItem('blockchain_auth_type');
            localStorage.removeItem('blockchain_auth_session');
            localStorage.removeItem('redirect_count');
            
            alert('已重置认证状态，页面将刷新');
            window.location.href = 'login.html?no_redirect=true';
        });

        // 检查是否有循环重定向的迹象
        const redirectCount = parseInt(localStorage.getItem('redirect_count') || '0');
        if (redirectCount > 3) {
            // 显示重定向警告
            document.getElementById('redirectWarning').classList.remove('hidden');
        }
    });
</script>

<script>
    // --- DOM 元素获取 ---
    const authOptionsDiv = document.getElementById('authOptions');
    const showDidLoginButton = document.getElementById('showDidLoginButton');
    const anonymousLoginButton = document.getElementById('anonymousLoginButton');

    const didAuthSection = document.getElementById('didAuthSection');
    const anonymousAuthSection = document.getElementById('anonymousAuthSection');
    
    // 标签页切换
    const createDidTab = document.getElementById('createDidTab');
    const useDidTab = document.getElementById('useDidTab');
    const createDidPanel = document.getElementById('createDidPanel');
    const useDidPanel = document.getElementById('useDidPanel');
    
    // 创建DID相关元素
    const genKeyBtn = document.getElementById('genKeyBtn');
    const uploadKeyBtn = document.getElementById('uploadKeyBtn');
    const genKeyArea = document.getElementById('genKeyArea');
    const uploadKeyArea = document.getElementById('uploadKeyArea');
    const pubKeyInput = document.getElementById('pubKeyInput');
    const selectKeyFileBtn = document.getElementById('selectKeyFileBtn');
    const keyFileInput = document.getElementById('keyFileInput');
    const createDidFromKeyBtn = document.getElementById('createDidFromKeyBtn');
    const createDidButton = document.getElementById('createDidButton');
    const createdDidInfo = document.getElementById('createdDidInfo');
    
    // 使用已有DID相关元素
    const didSelector = document.getElementById('didSelector');
    const useDidBtn = document.getElementById('useDidBtn');
    const deleteDidBtn = document.getElementById('deleteDidBtn');
    const manualDidInput = document.getElementById('manualDidInput');
    const useManualDidBtn = document.getElementById('useManualDidBtn');
    
    // 认证流程相关元素
    const authPanel = document.getElementById('authPanel');
    const step1GetChallenge = document.getElementById('step1GetChallenge');
    const step2SignChallenge = document.getElementById('step2SignChallenge');
    const currentDidInput = document.getElementById('currentDidInput');
    const getChallengeBtn = document.getElementById('getChallengeBtn');
    const challengeText = document.getElementById('challengeText');
    const copyChallenge = document.getElementById('copyChallenge');
    const keyIdInput = document.getElementById('keyIdInput');
    const signWithLocalBtn = document.getElementById('signWithLocalBtn');
    const toggleManualSignBtn = document.getElementById('toggleManualSignBtn');
    const manualSignArea = document.getElementById('manualSignArea');
    const manualSignatureInput = document.getElementById('manualSignatureInput');
    const signatureText = document.getElementById('signatureText');
    const verifyBtn = document.getElementById('verifyBtn');
    const backBtn = document.getElementById('backBtn');
    
    // 匿名认证相关元素
    const initiateAnonymousAuthButton = document.getElementById('initiateAnonymousAuthButton');
    const anonymousChallengeDisplay = document.getElementById('anonymousChallengeDisplay');
    const anonymousChallengeTextElem = document.getElementById('anonymousChallengeText');
    const signAnonymousChallengeButton = document.getElementById('signAnonymousChallengeButton');
    const anonymousVerificationDisplay = document.getElementById('anonymousVerificationDisplay');
    const anonymousTempPublicKeyElem = document.getElementById('anonymousTempPublicKey');
    const anonymousSignatureElem = document.getElementById('anonymousSignature');
    const verifyAnonymousAuthButton = document.getElementById('verifyAnonymousAuthButton');
    const backToAuthOptionsButton = document.getElementById('backToAuthOptionsButton');
    
    const messageArea = document.getElementById('messageArea');
    
    const SPRING_BOOT_API_BASE_URL = 'http://localhost:8080/api/did';
    
    // --- 应用程序状态 ---
    let currentChallengeText = ''; // DID登录挑战码
    let currentActiveDid = null;   // 当前使用的DID
    let currentActiveKeyId = null; // 当前使用的KeyID
    let isManualSignMode = false;  // 是否使用手动签名
    let currentAnonymousChallenge = ''; // 匿名认证挑战码
    let temporaryKeyPair = null;   // 匿名认证临时密钥对
    
    // --- IndexedDB 配置 ---
    const DB_NAME = "DIDKeyStore";
    const DB_VERSION = 1;
    const OBJECT_STORE_NAME = "userKeys";
    let db;
    
    // --- IndexedDB 辅助函数 ---
    function openDb() {
        return new Promise((resolve, reject) => {
            if (db) {
                resolve(db);
                return;
            }
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => reject("打开IndexedDB数据库失败: " + event.target.errorCode);
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const storeDb = event.target.result;
                if (!storeDb.objectStoreNames.contains(OBJECT_STORE_NAME)) {
                    const objectStore = storeDb.createObjectStore(OBJECT_STORE_NAME, { keyPath: "did" });
                    objectStore.createIndex("keyId", "keyId", { unique: false });
                    console.log("IndexedDB object store '" + OBJECT_STORE_NAME + "' 已创建.");
                }
            };
        });
    }

    function addKeyToDb(keyInfo) {
        return new Promise(async (resolve, reject) => {
            try {
                const currentDb = await openDb();
                const transaction = currentDb.transaction([OBJECT_STORE_NAME], "readwrite");
                const store = transaction.objectStore(OBJECT_STORE_NAME);
                const request = store.put(keyInfo);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject("添加密钥到IndexedDB失败: " + event.target.error);
            } catch (error) {
                reject(error);
            }
        });
    }

    function getKeyFromDb(did) {
        return new Promise(async (resolve, reject) => {
            try {
                const currentDb = await openDb();
                const transaction = currentDb.transaction([OBJECT_STORE_NAME], "readonly");
                const store = transaction.objectStore(OBJECT_STORE_NAME);
                const request = store.get(did);
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject("从IndexedDB获取密钥失败: " + event.target.error);
            } catch (error) {
                reject(error);
            }
        });
    }

    function getAllKeysFromDb() {
        return new Promise(async (resolve, reject) => {
            try {
                const currentDb = await openDb();
                const transaction = currentDb.transaction([OBJECT_STORE_NAME], "readonly");
                const store = transaction.objectStore(OBJECT_STORE_NAME);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject("从IndexedDB获取所有密钥失败: " + event.target.error);
            } catch (error) {
                reject(error);
            }
        });
    }

    function deleteKeyFromDb(did) {
        return new Promise(async (resolve, reject) => {
            try {
                const currentDb = await openDb();
                const transaction = currentDb.transaction([OBJECT_STORE_NAME], "readwrite");
                const store = transaction.objectStore(OBJECT_STORE_NAME);
                const request = store.delete(did);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject("从IndexedDB删除密钥失败: " + event.target.error);
            } catch (error) {
                reject(error);
            }
        });
    }
    
    // --- Web Crypto API 辅助函数 ---
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    async function generateRsaKeyPair() {
        return await window.crypto.subtle.generateKey(
            {
                name: "RSASSA-PKCS1-v1_5",
                modulusLength: 2048,
                publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
                hash: "SHA-256",
            },
            true,
            ["sign", "verify"]
        );
    }

    async function exportPublicKeyAsBase64Spki(publicKey) {
        const exportedSpki = await window.crypto.subtle.exportKey("spki", publicKey);
        return arrayBufferToBase64(exportedSpki);
    }
    
    // --- 公钥处理函数 ---
    function processPubKeyInput(input) {
        input = input.trim();
        
        // 检查是否是PEM格式
        if (input.includes('-----BEGIN PUBLIC KEY-----')) {
            // 移除PEM头尾和所有换行符
            input = input.replace('-----BEGIN PUBLIC KEY-----', '')
                    .replace('-----END PUBLIC KEY-----', '')
                    .replace(/[\r\n]/g, '');
        }
        
        // 此时应该是Base64格式，验证
        try {
            // 尝试解码Base64确认格式正确
            atob(input);
            return input;
        } catch(e) {
            throw new Error('公钥格式无效。请提供有效的PEM格式或Base64编码公钥。');
        }
    }
    
    // 读取公钥文件
    function readPubKeyFile(file) {
        return new Promise((resolve, reject) => {
            if (!file) {
                reject(new Error('未选择文件'));
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const processedKey = processPubKeyInput(content);
                    resolve(processedKey);
                } catch(error) {
                    reject(error);
                }
            };
            reader.onerror = function() {
                reject(new Error('读取文件失败'));
            };
            reader.readAsText(file);
        });
    }
    
    // --- UI 更新函数 ---
    async function populateDidSelector() {
        try {
            const keys = await getAllKeysFromDb();
            didSelector.innerHTML = ''; // 清空选项
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = keys && keys.length > 0 ? "-- 请选择 --" : "-- 无可用DID --";
            didSelector.appendChild(defaultOption);
            
            if (keys && keys.length > 0) {
                keys.forEach(keyInfo => {
                    const option = document.createElement('option');
                    option.value = keyInfo.did;
                    option.textContent = `${keyInfo.did} (KeyID: ${keyInfo.keyId})`;
                    didSelector.appendChild(option);
                });
            }
        } catch (error) {
            console.error("填充DID选择器失败:", error);
            messageArea.textContent = "加载已存储DID列表失败: " + error.message;
            messageArea.classList.add('text-red-600');
        }
    }
    
    function setActiveDid(did, keyId = null) {
        currentActiveDid = did;
        currentActiveKeyId = keyId;
        currentDidInput.value = did;
        
        if (keyId) {
            keyIdInput.value = keyId;
        } else {
            keyIdInput.value = '';
        }
        
        // 显示认证面板
        step1GetChallenge.classList.remove('hidden');
        step2SignChallenge.classList.add('hidden');
        messageArea.textContent = '已选择DID，请获取挑战码';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
    }
    
    // --- 页面事件处理 ---
    
    // 页面加载时初始化
    window.addEventListener('load', async () => {
        try {
            await openDb();
            await populateDidSelector();
            console.log("IndexedDB已初始化，DID选择器已填充。");
        } catch (error) {
            console.error("初始化失败:", error);
            messageArea.textContent = "初始化失败: " + error.message;
            messageArea.classList.add('text-red-600');
        }
        
        // 默认显示认证方式选择
        authOptionsDiv.classList.remove('hidden');
        didAuthSection.classList.add('hidden');
        anonymousAuthSection.classList.add('hidden');
        
        // 设置默认标签页
        createDidTab.classList.add('tab-active');
        useDidTab.classList.remove('tab-active');
        createDidPanel.classList.remove('hidden');
        useDidPanel.classList.add('hidden');
        
        // 设置默认创建DID视图
        genKeyArea.classList.remove('hidden');
        uploadKeyArea.classList.add('hidden');
    });
    
    // 切换到DID登录界面
    showDidLoginButton.addEventListener('click', () => {
        authOptionsDiv.classList.add('hidden');
        didAuthSection.classList.remove('hidden');
        anonymousAuthSection.classList.add('hidden');
        messageArea.textContent = '请创建或使用DID账户';
    });
    
    // 切换到匿名登录界面
    anonymousLoginButton.addEventListener('click', () => {
        authOptionsDiv.classList.add('hidden');
        didAuthSection.classList.add('hidden');
        anonymousAuthSection.classList.remove('hidden');
        anonymousChallengeDisplay.classList.add('hidden');
        anonymousVerificationDisplay.classList.add('hidden');
        initiateAnonymousAuthButton.classList.remove('hidden');
        messageArea.textContent = '请开始匿名认证流程';
    });
    
    // 返回选择登录方式
    backToAuthOptionsButton.addEventListener('click', () => {
        authOptionsDiv.classList.remove('hidden');
        didAuthSection.classList.add('hidden');
        anonymousAuthSection.classList.add('hidden');
        messageArea.textContent = '';
    });
    
    // --- DID创建和使用标签页切换 ---
    createDidTab.addEventListener('click', () => {
        createDidTab.classList.add('tab-active');
        useDidTab.classList.remove('tab-active');
        createDidPanel.classList.remove('hidden');
        useDidPanel.classList.add('hidden');
    });
    
    useDidTab.addEventListener('click', () => {
        useDidTab.classList.add('tab-active');
        createDidTab.classList.remove('tab-active');
        useDidPanel.classList.remove('hidden');
        createDidPanel.classList.add('hidden');
    });
    
    // --- 创建DID相关事件 ---
    
    // 切换到生成密钥视图
    genKeyBtn.addEventListener('click', () => {
        genKeyArea.classList.remove('hidden');
        uploadKeyArea.classList.add('hidden');
    });
    
    // 切换到上传公钥视图
    uploadKeyBtn.addEventListener('click', () => {
        uploadKeyArea.classList.remove('hidden');
        genKeyArea.classList.add('hidden');
    });
    
    // 选择公钥文件
    selectKeyFileBtn.addEventListener('click', () => {
        keyFileInput.click();
    });
    
    // 处理选择的公钥文件
    keyFileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        messageArea.textContent = '正在读取公钥文件...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
        
        try {
            const publicKeyBase64 = await readPubKeyFile(file);
            pubKeyInput.value = publicKeyBase64;
            messageArea.textContent = '公钥文件读取成功';
            messageArea.classList.add('text-green-600');
        } catch (error) {
            console.error('读取公钥文件失败:', error);
            messageArea.textContent = `读取公钥文件失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
        }
    });
    
    // 从上传的公钥创建DID
    createDidFromKeyBtn.addEventListener('click', async () => {
        const publicKeyBase64 = pubKeyInput.value.trim();
        if (!publicKeyBase64) {
            messageArea.textContent = '请先输入公钥或选择公钥文件';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        messageArea.textContent = '正在处理公钥并注册DID...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
        createdDidInfo.classList.add('hidden');
        
        try {
            // 处理输入的公钥
            const processedKey = processPubKeyInput(publicKeyBase64);
            
            const response = await fetch(`${SPRING_BOOT_API_BASE_URL}/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ publicKeyBase64: processedKey })
            });
            
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || result.error || `创建DID失败 (${response.status})`);
            }
            
            const newDidString = result.didDocument.id;
            const newKeyId = result.didDocument.authentication && result.didDocument.authentication.length > 0
                ? result.didDocument.authentication[0]
                : `${newDidString}#keys-1`;
            
            // 不存储私钥，仅记录DID和公钥
            const keyInfoToStore = {
                did: newDidString,
                keyId: newKeyId,
                publicKeyBase64: processedKey,
                hasPrivateKey: false
            };
            
            await addKeyToDb(keyInfoToStore);
            await populateDidSelector();
            setActiveDid(newDidString, newKeyId);
            
            messageArea.textContent = 'DID账户创建成功！';
            messageArea.classList.add('text-green-600');
            
            createdDidInfo.innerHTML = `
                <p><strong>DID:</strong> <span class="code-block">${newDidString}</span></p>
                <p><strong>KeyID:</strong> <span class="code-block">${newKeyId}</span></p>
                <p class="mt-2 text-green-700 font-semibold">已记录DID信息，请妥善保存您的私钥</p>`;
            createdDidInfo.classList.remove('hidden');
            
        } catch (error) {
            console.error('创建DID失败:', error);
            messageArea.textContent = `创建DID失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
        }
    });
    
    // 生成密钥对并创建DID
    createDidButton.addEventListener('click', async () => {
        messageArea.textContent = '正在生成密钥对并注册DID...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
        createdDidInfo.classList.add('hidden');
        
        try {
            const keyPair = await generateRsaKeyPair();
            const publicKeyBase64 = await exportPublicKeyAsBase64Spki(keyPair.publicKey);
            
            const response = await fetch(`${SPRING_BOOT_API_BASE_URL}/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ publicKeyBase64: publicKeyBase64 })
            });
            
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || result.error || `创建DID失败 (${response.status})`);
            }
            
            const newDidString = result.didDocument.id;
            const newKeyId = result.didDocument.authentication && result.didDocument.authentication.length > 0
                ? result.didDocument.authentication[0]
                : `${newDidString}#keys-1`;
            
            // 存储完整密钥信息（包括私钥）
            const keyInfoToStore = {
                did: newDidString,
                keyId: newKeyId,
                publicKeyBase64: publicKeyBase64,
                privateKey: keyPair.privateKey,
                hasPrivateKey: true
            };
            
            await addKeyToDb(keyInfoToStore);
            await populateDidSelector();
            setActiveDid(newDidString, newKeyId);
            
            messageArea.textContent = 'DID账户创建成功！';
            messageArea.classList.add('text-green-600');
            
            createdDidInfo.innerHTML = `
                <p><strong>DID:</strong> <span class="code-block">${newDidString}</span></p>
                <p><strong>KeyID:</strong> <span class="code-block">${newKeyId}</span></p>
                <p class="mt-2 text-green-700 font-semibold">密钥已安全存储在浏览器中</p>`;
            createdDidInfo.classList.remove('hidden');
            
        } catch (error) {
            console.error('创建DID失败:', error);
            messageArea.textContent = `创建DID失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
        }
    });
    
    // --- 使用已有DID相关事件 ---
    
    // 使用选择的DID
    useDidBtn.addEventListener('click', async () => {
        const selectedDid = didSelector.value;
        if (!selectedDid) {
            messageArea.textContent = '请选择一个DID账户';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        try {
            const keyInfo = await getKeyFromDb(selectedDid);
            if (keyInfo) {
                setActiveDid(keyInfo.did, keyInfo.keyId);
            } else {
                messageArea.textContent = '未找到选中DID的密钥信息';
                messageArea.classList.add('text-red-600');
            }
        } catch (error) {
            console.error('使用DID失败:', error);
            messageArea.textContent = `使用DID失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
        }
    });
    
    // 删除选择的DID
    deleteDidBtn.addEventListener('click', async () => {
        const didToDelete = didSelector.value;
        if (!didToDelete) {
            messageArea.textContent = '请选择要删除的DID账户';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        if (confirm(`确定要删除DID账户 "${didToDelete}" 及其密钥信息吗？此操作不可恢复。`)) {
            try {
                await deleteKeyFromDb(didToDelete);
                await populateDidSelector();
                
                messageArea.textContent = 'DID账户已删除';
                messageArea.className = 'mt-6 text-center text-sm text-green-600';
                
                if (currentActiveDid === didToDelete) {
                    currentActiveDid = null;
                    currentActiveKeyId = null;
                    currentDidInput.value = '';
                }
            } catch (error) {
                console.error('删除DID失败:', error);
                messageArea.textContent = `删除DID失败: ${error.message}`;
                messageArea.classList.add('text-red-600');
            }
        }
    });
    
    // 使用手动输入的DID
    useManualDidBtn.addEventListener('click', () => {
        const manualDid = manualDidInput.value.trim();
        if (!manualDid) {
            messageArea.textContent = '请输入DID';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        if (!manualDid.startsWith('did:')) {
            messageArea.textContent = 'DID格式无效，应以"did:"开头';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        setActiveDid(manualDid);
    });
    
    // --- 认证流程相关事件 ---
    
    // 获取挑战码
    getChallengeBtn.addEventListener('click', async () => {
        if (!currentActiveDid) {
            messageArea.textContent = '请先创建或选择DID账户';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        messageArea.textContent = '正在获取挑战码...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
        
        try {
            const response = await fetch(`${SPRING_BOOT_API_BASE_URL}/auth/challenge`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ did: currentActiveDid })
            });
            
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || result.error || `获取挑战码失败 (${response.status})`);
            }
            
            currentChallengeText = result.challenge;
            challengeText.value = currentChallengeText;
            
            // 如果服务器返回了keyIdHint，使用它
            if (result.keyIdHint) {
                keyIdInput.value = result.keyIdHint;
            } else if (currentActiveKeyId) {
                keyIdInput.value = currentActiveKeyId;
            } else {
                keyIdInput.value = `${currentActiveDid}#keys-1`;
            }
            
            // 重置签名区域
            signatureText.value = '';
            manualSignatureInput.value = '';
            manualSignArea.classList.add('hidden');
            isManualSignMode = false;
            
            // 显示挑战码签名区域
            step1GetChallenge.classList.add('hidden');
            step2SignChallenge.classList.remove('hidden');
            
            messageArea.textContent = '请签名挑战码';
            messageArea.classList.add('text-blue-600');
            
        } catch (error) {
            console.error('获取挑战码失败:', error);
            messageArea.textContent = `获取挑战码失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
        }
    });
    
    // 复制挑战码
    copyChallenge.addEventListener('click', () => {
        navigator.clipboard.writeText(challengeText.value)
            .then(() => {
                copyChallenge.textContent = '已复制!';
                setTimeout(() => {
                    copyChallenge.textContent = '复制';
                }, 2000);
            })
            .catch(err => {
                console.error('复制失败:', err);
                messageArea.textContent = '复制挑战码失败，请手动复制';
                messageArea.classList.add('text-red-600');
            });
    });
    
    // 使用本地私钥签名
    signWithLocalBtn.addEventListener('click', async () => {
        if (!currentActiveDid || !currentChallengeText) {
            messageArea.textContent = '无效的DID或挑战码';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        const keyIdForSigning = keyIdInput.value.trim();
        if (!keyIdForSigning) {
            messageArea.textContent = '请输入密钥ID';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        // 关闭手动签名区域
        manualSignArea.classList.add('hidden');
        isManualSignMode = false;
        
        messageArea.textContent = '正在使用浏览器中的私钥签名...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
        
        try {
            const keyInfo = await getKeyFromDb(currentActiveDid);
            if (!keyInfo) {
                throw new Error(`未找到DID '${currentActiveDid}' 的密钥信息`);
            }
            
            if (!keyInfo.hasPrivateKey || !keyInfo.privateKey) {
                throw new Error(`浏览器中没有此DID的私钥，请使用手动签名`);
            }
            
            const signatureArrayBuffer = await window.crypto.subtle.sign(
                { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
                keyInfo.privateKey,
                new TextEncoder().encode(currentChallengeText)
            );
            
            signatureText.value = arrayBufferToBase64(signatureArrayBuffer);
            messageArea.textContent = '签名成功，请验证登录';
            messageArea.classList.add('text-green-600');
            
        } catch (error) {
            console.error('签名失败:', error);
            messageArea.textContent = `签名失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
        }
    });
    
    // 切换到手动签名模式
    toggleManualSignBtn.addEventListener('click', () => {
        manualSignArea.classList.remove('hidden');
        isManualSignMode = true;
        signatureText.value = '';
        messageArea.textContent = '请在外部使用私钥签名挑战码，然后粘贴签名结果';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
    });
    
    // 监听手动签名输入
    manualSignatureInput.addEventListener('input', (e) => {
        signatureText.value = e.target.value.trim();
    });
    
    // 验证登录
    verifyBtn.addEventListener('click', async () => {
        const signature = signatureText.value.trim();
        const keyId = keyIdInput.value.trim();
        
        if (!currentActiveDid || !currentChallengeText || !signature || !keyId) {
            messageArea.textContent = '验证信息不完整';
            messageArea.classList.add('text-red-600');
            return;
        }
        
        messageArea.textContent = '正在验证...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
        
        try {
            const response = await fetch(`${SPRING_BOOT_API_BASE_URL}/auth/verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    did: currentActiveDid,
                    challenge: currentChallengeText,
                    signatureBase64: signature,
                    keyId: keyId
                })
            });
            
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || `验证失败 (${response.status})`);
            }
            
            if (result.success) {
                // 保存认证信息到localStorage
                localStorage.setItem('blockchain_auth_token', result.token || 'authenticated');
                localStorage.setItem('blockchain_auth_did', currentActiveDid);
                localStorage.setItem('blockchain_auth_session', result.sessionId || '');
                localStorage.setItem('blockchain_auth_type', 'did');
                
                // 设置认证标志
                localStorage.setItem('blockchain_auth_status', 'authenticated');
                
                messageArea.textContent = '登录成功！正在跳转...';
                messageArea.classList.add('text-green-600');
                
                // 获取重定向URL参数，如果没有则默认到index.html
                const urlParams = new URLSearchParams(window.location.search);
                const redirectUrl = urlParams.get('redirect') || 'index.html';
                
                // 使用一个短暂的延迟确保本地存储完成
                setTimeout(() => { 
                    window.location.href = redirectUrl; 
                }, 500);
            } else {
                throw new Error(result.message || '验证失败');
            }
            
        } catch (error) {
            console.error('验证失败:', error);
            messageArea.textContent = `验证失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
        }
    });
    
    // 返回按钮
    backBtn.addEventListener('click', () => {
        step2SignChallenge.classList.add('hidden');
        step1GetChallenge.classList.remove('hidden');
        messageArea.textContent = '请获取挑战码';
    });
    
    // --- 匿名认证流程事件处理 ---

    initiateAnonymousAuthButton.addEventListener('click', async () => {
        messageArea.textContent = '正在请求挑战码...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
        try {
            const response = await fetch(`${SPRING_BOOT_API_BASE_URL}/auth/anonymous-challenge`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || result.error || `获取挑战码失败 (${response.status})`);
            }

            currentAnonymousChallenge = result.challenge;
            anonymousChallengeTextElem.textContent = currentAnonymousChallenge;

            initiateAnonymousAuthButton.classList.add('hidden');
            anonymousChallengeDisplay.classList.remove('hidden');
            anonymousVerificationDisplay.classList.add('hidden');
            messageArea.textContent = '请生成密钥并签名挑战码';
            messageArea.classList.add('text-blue-600');

        } catch (error) {
            console.error('获取挑战码失败:', error);
            messageArea.textContent = `获取挑战码失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
            initiateAnonymousAuthButton.classList.remove('hidden');
        }
    });

    signAnonymousChallengeButton.addEventListener('click', async () => {
        if (!currentAnonymousChallenge) {
            messageArea.textContent = '无效的挑战码';
            messageArea.classList.add('text-red-600');
            return;
        }
        messageArea.textContent = '正在生成密钥并签名...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';
        try {
            temporaryKeyPair = await generateRsaKeyPair();
            const publicKeyBase64 = await exportPublicKeyAsBase64Spki(temporaryKeyPair.publicKey);

            const signatureArrayBuffer = await window.crypto.subtle.sign(
                { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
                temporaryKeyPair.privateKey,
                new TextEncoder().encode(currentAnonymousChallenge)
            );
            const signatureBase64 = arrayBufferToBase64(signatureArrayBuffer);

            anonymousTempPublicKeyElem.value = publicKeyBase64;
            anonymousSignatureElem.value = signatureBase64;

            anonymousChallengeDisplay.classList.add('hidden');
            anonymousVerificationDisplay.classList.remove('hidden');
            messageArea.textContent = '签名成功，请验证登录';
            messageArea.classList.add('text-green-600');

        } catch (error) {
            console.error("签名失败:", error);
            messageArea.textContent = `签名失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
            anonymousChallengeDisplay.classList.remove('hidden');
        }
    });

    verifyAnonymousAuthButton.addEventListener('click', async () => {
        const tempKey = anonymousTempPublicKeyElem.value;
        const sig = anonymousSignatureElem.value;

        if (!currentAnonymousChallenge || !tempKey || !sig) {
            messageArea.textContent = '验证信息不完整';
            messageArea.classList.add('text-red-600');
            return;
        }
        messageArea.textContent = '正在验证...';
        messageArea.className = 'mt-6 text-center text-sm text-blue-600';

        try {
            const response = await fetch(`${SPRING_BOOT_API_BASE_URL}/auth/anonymous-verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    challenge: currentAnonymousChallenge,
                    temporaryPublicKeyBase64: tempKey,
                    signatureBase64: sig
                }),
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || `验证失败 (${response.status})`);
            }

            if (result.success) {
                // 保存匿名认证信息到localStorage
                localStorage.setItem('blockchain_auth_token', result.token || 'anonymous_authenticated');
                localStorage.setItem('blockchain_auth_type', 'anonymous');
                localStorage.setItem('blockchain_auth_session', result.sessionId || '');
                
                // 设置认证标志
                localStorage.setItem('blockchain_auth_status', 'authenticated');
                
                messageArea.textContent = '登录成功！正在跳转...';
                messageArea.classList.add('text-green-600');
                
                // 获取重定向URL参数，如果没有则默认到index.html
                const urlParams = new URLSearchParams(window.location.search);
                const redirectUrl = urlParams.get('redirect') || 'index.html';
                
                // 使用一个短暂的延迟确保本地存储完成
                setTimeout(() => { 
                    window.location.href = redirectUrl; 
                }, 500);
            } else {
                throw new Error(result.message || '验证失败');
            }
        } catch (error) {
            console.error('验证失败:', error);
            messageArea.textContent = `验证失败: ${error.message}`;
            messageArea.classList.add('text-red-600');
            anonymousVerificationDisplay.classList.add('hidden');
            initiateAnonymousAuthButton.classList.remove('hidden');
        }
    });

</script>
</body>
</html>



